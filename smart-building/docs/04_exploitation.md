# 4. Dossier d'Exploitation (RUN / MCO)

Ce dossier décrit le Maintien en Condition Opérationnelle (MCO) et la gestion du cycle de vie des applicatifs du Front et du Back sur la machine Linux Cible.

## Écosystème & Hébergement
-  **Serveur Cible:** `76.13.59.115` (Droplet DigitalOcean / VPS Ubuntu).
-  **Compte Utilisateur:** `root` (Pour la V1, déploiements effectués via clés asymétriques SSH).
-  **Dossier Racine:** `/opt/gravity-lab/smart-building`
-  **Process Manager:** PM2 (Gestionnaire de daemon pour applications Node.js en continu).

## Commandes Fréquentes d'Exploitation

### Backend (API & WebSockets Express)
Le Backend gère les API et héberge la base de donnée SQLite locale.

- **Redémarrer le Backend :**
  ```bash
  pm2 restart gtb-backend
  ```
- **Lire les Logs Backend (Erreurs / Pushs WebSocket) :**
  ```bash
  pm2 logs gtb-backend --lines 200
  ```

### Frontend (Next.js Application B2B)
L'application Front tourne soit en mode Serveur (Next.js Node) soit sur des exports statiques.

- **Redémarrer le Frontend :**
  ```bash
  pm2 restart gtb-frontend
  ```
- **Lire les Logs Frontend :**
  ```bash
  pm2 logs gtb-frontend --lines 200
  ```

### Scripts Automatisés de Déploiement (Pipeline SSH)
Le projet maintient une suite de scripts CommonJS (`.cjs`) agissant comme des runners simplifiés (Simili-Ansible) qui s'exécutent en local pour ordonner la compilation distante.

- **`ssh_build_front.cjs` :** Outil de déploiement à chaud du Frontend. 
  1. Se connecte en SSH au VPS.
  2. Procède à un `git pull` sur le repository.
  3. Réinstalle les dépendances Frontend (`npm i`).
  4. Compile le Frontend (`npm run build`).
  5. Relance PM2 silencieusement et remonte les métriques de succès.

- **`fetch_alerts.cjs` / `ssh_restore_users.cjs` :** Scripts utilitaires d'injection de logs métiers/erreurs dans la base de données de production pour des besoins de démonstration commerciale sans attendre l'IoT réel.

### Surveillance de la machine (Serveur)
Utilisation générique des outils de performance Ubuntu.
- `htop` : Surconsommation éventuelle de la RAM par PM2 ou Next.js Build Processes.
- `pm2 monit` : Tableau de bord visuel Node.js affichant le CPU/Memory des Workers.

## Procédures d'Urgence

1. **Perte de mot de passe "Super Admin" UBBEE :**
   Exécuter les scripts de "Seed" depuis le serveur distant. La base de données SQLite écrasera et reconfigura le plan de compte à son état de distribution.
   
2. **Crash Silencieux du WebSockets Frontend :**
   Si les données temps réel ne bougent plus sur la plateforme sans indiquer d'erreur, c'est que le worker PM2 Backend du Socket a été déconnecté (Timeout). Exécuter un `pm2 restart gtb-backend` force la reconnexion automatique des clients Front.
